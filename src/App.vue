<template>
  <v-app id="alerta" :dark="isDark">
    <v-navigation-drawer
      v-model="drawer"
      :clipped="$vuetify.breakpoint.lgAndUp"
      fixed
      app
    >
      <v-toolbar flat>
        <v-toolbar-side-icon
          @click.stop="drawer = !drawer"
        ></v-toolbar-side-icon>

        <img
          v-if="$config.site_logo_url"
          :src="$config.site_logo_url"
          height="48"
        />
        <v-toolbar-title v-else class="logo">
          alerta
        </v-toolbar-title>
      </v-toolbar>

      <v-divider></v-divider>
      <v-list dense>
        <template v-for="item in items">
          <v-layout v-if="item.heading" :key="item.heading" row align-center>
            <v-flex xs6>
              <v-subheader v-if="item.heading">
                {{ item.heading }}
              </v-subheader>
            </v-flex>
            <v-flex xs6 class="text-xs-center">
              <a href="#!" class="body-2 black--text">EDIT</a>
            </v-flex>
          </v-layout>
          <v-list-group
            v-else-if="item.children"
            :key="item.text"
            v-model="item.model"
            :prepend-icon="item.model ? item.icon : item['icon-alt']"
            append-icon=""
          >
            <v-list-tile slot="activator">
              <v-list-tile-content>
                <v-list-tile-title>
                  {{ item.text }}
                </v-list-tile-title>
              </v-list-tile-content>
            </v-list-tile>
            <v-list-tile v-for="(child, i) in item.children" :key="i">
              <v-list-tile-action v-if="child.icon">
                <v-icon>{{ child.icon }}</v-icon>
              </v-list-tile-action>
              <v-list-tile-content>
                <v-list-tile-title>
                  {{ child.text }}
                </v-list-tile-title>
              </v-list-tile-content>
            </v-list-tile>
          </v-list-group>
          <v-list-tile
            v-else
            :key="item.text"
            v-has-perms="item.perms"
            :to="item.path"
          >
            <v-list-tile-action>
              <v-icon>{{ item.icon }}</v-icon>
            </v-list-tile-action>
            <v-list-tile-content>
              <v-list-tile-title>
                {{ item.text }}
              </v-list-tile-title>
            </v-list-tile-content>
          </v-list-tile>
        </template>
      </v-list>
    </v-navigation-drawer>

    <v-toolbar>
      <v-toolbar-side-icon @click.stop="drawer = !drawer"></v-toolbar-side-icon>

      <img
        v-if="$config.site_logo_url"
        :src="$config.site_logo_url"
        height="48"
      />
      <v-toolbar-title v-else class="logo">
        alerta
      </v-toolbar-title>

      <v-spacer></v-spacer>

      <v-text-field
        v-if="$route.name === 'alerts'"
        v-model="query"
        :flat="!hasFocus"
        label="Search"
        prepend-inner-icon="search"
        solo
        clearable
        height="44"
        class="pt-2 hidden-sm-and-down"
        @focus="hasFocus = true"
        @blur="hasFocus = false"
        @change="submitSearch"
        @click:clear="clearSearch"
      ></v-text-field>

      <v-spacer></v-spacer>

      <!-- <v-btn icon>
        <v-icon>search</v-icon>
      </v-btn> -->

      <div>
        <v-tooltip left>
          <v-switch
            slot="activator"
            :input-value="isWatch"
            hide-details
            open-delay="3000"
            @change="toggle('isWatch', $event)"
          >
          </v-switch>
          <span>Watch</span>
        </v-tooltip>
      </div>

      <v-btn icon @click="toggleFullScreen">
        <v-icon>{{ isFullscreen() ? 'fullscreen_exit' : 'fullscreen' }}</v-icon>
      </v-btn>

      <v-btn icon>
        <v-icon @click="refresh">refresh</v-icon>
      </v-btn>

      <v-menu
        v-model="menu"
        :close-on-content-click="false"
        :nudge-width="200"
        offset-x
        :disabled="!isLoggedIn"
      >
        <v-btn slot="activator" :disabled="!isLoggedIn" icon>
          <v-icon>{{ navbar.signin.icon }}</v-icon>
        </v-btn>

        <profile-me v-if="profile" :profile="profile" @close="menu = false" />
      </v-menu>
    </v-toolbar>

    <v-content>
      <banner />
      <router-view />
      <snackbar />
    </v-content>
  </v-app>
</template>

<script>
import Banner from '@/components/Banner.vue'
import ProfileMe from '@/components/ProfileMe.vue'
import Snackbar from '@/components/Snackbar.vue'

export default {
  name: 'App',
  components: {
    Banner,
    ProfileMe,
    Snackbar
  },
  props: [],
  data: () => ({
    hasFocus: false,
    menu: false,
    message: false,
    hints: true,
    dialog: false,
    drawer: null,
    navbar: {
      signin: { icon: 'account_circle', text: 'Sign In', path: '/login' }
    },
    items: [
      { icon: 'list', text: 'Alerts', path: '/alerts', perms: 'read:alerts' },
      {
        icon: 'timer',
        text: 'Heartbeats',
        path: '/heartbeats',
        perms: 'read:heartbeats'
      },
      { icon: 'people', text: 'Users', path: '/users', perms: 'read:users' },
      {
        icon: 'domain',
        text: 'Customers',
        path: '/customers',
        perms: 'read:customers'
      },
      {
        icon: 'notifications_off',
        text: 'Blackouts',
        path: '/blackouts',
        perms: 'read:blackouts'
      },
      {
        icon: 'security',
        text: 'Permissions',
        path: '/perms',
        perms: 'read:perms'
      },
      { icon: 'vpn_key', text: 'API Keys', path: '/keys', perms: 'read:keys' },
      {
        icon: 'keyboard_arrow_up',
        'icon-alt': 'keyboard_arrow_down',
        text: 'Labels',
        model: true,
        children: [{ icon: 'add', text: 'Create label' }]
      },
      // {
      //   icon: 'keyboard_arrow_up',
      //   'icon-alt': 'keyboard_arrow_down',
      //   text: 'More',
      //   model: false,
      //   children: [
      //     { text: 'Import' },
      //     { text: 'Export' },
      //     { text: 'Print' },
      //     { text: 'Undo changes' },
      //     { text: 'Other contacts' }
      //   ]
      // },
      { icon: 'settings', text: 'Settings', path: '/settings' },
      // { icon: 'chat_bubble', text: 'Send feedback' },
      { icon: 'help', text: 'Help', path: 'https://docs.alerta.io' },
      { icon: 'info', text: 'About', path: '/about', perms: 'read:management' }
    ]
  }),
  computed: {
    isDark() {
      return this.$store.getters.getPreference('isDark')
    },
    isWatch() {
      return this.$store.state.alerts.isWatch
    },
    isLoggedIn() {
      return this.$store.getters['auth/isLoggedIn']
    },
    isCustomerViews() {
      return this.$store.getters['auth/isCustomerViews']
    },
    profile() {
      return this.$store.state.auth.payload || {}
    },
    query: {
      get() {
        return this.$store.state.alerts.query
          ? this.$store.state.alerts.query.q
          : null
      },
      set(value) {
        // FIXME: offer query suggestions to user here, in future
      }
    }
  },
  methods: {
    submitSearch(query) {
      this.$store.dispatch('alerts/updateQuery', { q: query })
      this.$router.push({
        query: { ...this.$router.query, q: query }
      })
      this.refresh()
    },
    clearSearch() {
      this.query = null
      this.$store.dispatch('alerts/updateQuery', null)
      this.$router.push({
        query: { ...this.$router.query, q: undefined }
      })
      this.refresh()
    },
    toggle(sw, value) {
      this.$store.dispatch('alerts/toggle', [sw, value])
    },
    toggleFullScreen() {
      let elem = document.getElementById('alerta')
      if (!this.isFullscreen()) {
        elem.requestFullscreen()
      } else {
        document.exitFullscreen()
      }
    },
    isFullscreen() {
      return document.fullscreenElement
    },
    refresh() {
      this.$store.dispatch('set', ['refresh', true])
      setTimeout(() => {
        this.$store.dispatch('set', ['refresh', false])
      }, 300)
    }
  }
}
</script>

<style>
@font-face {
  font-family: Roboto;
  src: url('assets/fonts/Roboto/Roboto-Regular.ttf');
}

@font-face {
  font-family: Roboto;
  font-weight: light;
  src: url('assets/fonts/Roboto/Roboto-Light.ttf');
}

@font-face {
  font-family: Roboto;
  font-weight: medium;
  src: url('assets/fonts/Roboto/Roboto-Medium.ttf');
}

@font-face {
  font-family: Roboto;
  font-weight: bold;
  src: url('assets/fonts/Roboto/Roboto-Bold.ttf');
}

@font-face {
  font-family: 'Roboto Condensed';
  src: url('assets/fonts/RobotoCondensed/RobotoCondensed-Regular.ttf');
}

@font-face {
  font-family: 'Roboto Condensed';
  font-weight: light;
  src: url('assets/fonts/RobotoCondensed/RobotoCondensed-Light.ttf');
}

@font-face {
  font-family: 'Roboto Condensed';
  font-weight: bold;
  src: url('assets/fonts/RobotoCondensed/RobotoCondensed-Bold.ttf');
}

@font-face {
  font-family: Sintony;
  src: url('assets/fonts/Sintony/Sintony-Regular.ttf');
}

@font-face {
  font-family: Sintony;
  font-weight: bold;
  src: url('assets/fonts/Sintony/Sintony-Bold.ttf');
}

@font-face {
  font-family: 'Sonsie One';
  src: url('assets/fonts/SonsieOne/SonsieOne-Regular.ttf');
}

.logo {
  font-family: 'Sonsie One', serif;
  font-size: 26px;
}
</style>
